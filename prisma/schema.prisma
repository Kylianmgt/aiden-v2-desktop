// AIDEN v2 Desktop - SQLite Schema
// Mirrors the server's PostgreSQL schema for local mode

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Authentication
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects     Project[]
  settings     UserSettings?
  chatSessions ChatSession[]
}

model UserSettings {
  id                 String  @id @default(cuid())
  userId             String  @unique
  emailNotifications Boolean @default(true)
  defaultTemplate    String  @default("nextjs")
  autoMergeApproved  Boolean @default(false)
  selectedAiProvider String?
  claudeApiKey       String?
  openaiApiKey       String?
  claudeCodeMode     String? @default("agentic")
  claudeCodeFastModel String? @default("claude-sonnet-4")
  autoStartRalph     Boolean @default(true)
  autoGeneratePrd    Boolean @default(true)
  promptEditorTheme  String? @default("dark")
  promptAutoSave     Boolean @default(true)
  githubAccessToken  String?
  githubUsername     String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Projects
model Project {
  id              String   @id @default(cuid())
  userId          String
  name            String
  slug            String
  description     String?
  type            String   @default("NEXTJS")
  status          String   @default("PLANNING")
  sourceType      String   @default("NEW")
  initialized     Boolean  @default(false)
  githubRepo      String?
  githubOwner     String?
  githubBranch    String   @default("main")
  outputDirectory String?
  initialPrompt   String?
  settings        String   @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  epics        Epic[]
  specs        Spec[]
  activities   Activity[]
  chatSessions ChatSession[]

  @@unique([userId, slug])
  @@index([userId])
  @@index([slug])
}

// Epics
model Epic {
  id          String   @id @default(cuid())
  projectId   String
  number      Int
  title       String
  description String?
  status      String   @default("PLANNING")
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stories Story[]
  specs   Spec[]

  @@unique([projectId, number])
  @@index([projectId])
}

// Stories
model Story {
  id              String   @id @default(cuid())
  epicId          String
  number          Int
  title           String
  description     String?
  status          String   @default("BACKLOG")
  complexity      String   @default("MEDIUM")
  order           Int      @default(0)
  specification   String   @default("{}")
  branch          String?
  baseBranch      String?
  useWorktree     Boolean  @default(false)
  worktreePath    String?
  lastCommitSha   String?
  commitCount     Int      @default(0)
  gitStatus       String   @default("{}")
  prNumber        Int?
  prUrl           String?
  prStatus        String?
  previewUrl      String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  epic          Epic           @relation(fields: [epicId], references: [id], onDelete: Cascade)
  agentSessions AgentSession[]
  chatSessions  ChatSession[]
  activities    Activity[]
  specs         Spec[]

  @@unique([epicId, number])
  @@index([epicId])
  @@index([status])
}

// Specs
model Spec {
  id        String   @id @default(cuid())
  projectId String
  storyId   String?
  epicId    String?
  type      String
  title     String
  content   String
  version   Int      @default(1)
  filePath  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  story   Story?  @relation(fields: [storyId], references: [id], onDelete: Cascade)
  epic    Epic?   @relation(fields: [epicId], references: [id], onDelete: Cascade)

  @@index([projectId, type])
  @@index([storyId])
  @@index([epicId])
}

// Agent Sessions
model AgentSession {
  id            String    @id @default(cuid())
  storyId       String
  status        String    @default("QUEUED")
  progress      Int       @default(0)
  workspacePath String?
  tokenUsage    Int       @default(0)
  error         String?
  retryCount    Int       @default(0)
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  story Story      @relation(fields: [storyId], references: [id], onDelete: Cascade)
  logs  AgentLog[]

  @@index([storyId])
  @@index([status])
}

// Agent Logs
model AgentLog {
  id        String   @id @default(cuid())
  sessionId String
  level     String
  message   String
  metadata  String?
  timestamp DateTime @default(now())

  session AgentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// Chat Sessions
model ChatSession {
  id             String   @id @default(cuid())
  projectId      String?
  storyId        String?
  agentSessionId String?
  userId         String
  type           String   @default("general")
  phase          String   @default("initial")
  context        String   @default("{}")
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  project  Project?      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  story    Story?        @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([projectId])
  @@index([storyId])
  @@index([userId])
}

// Chat Messages
model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String
  role      String
  content   String
  phase     String?
  metadata  String?
  createdAt DateTime @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// Activities
model Activity {
  id             String   @id @default(cuid())
  type           String
  message        String
  metadata       String?
  projectId      String?
  storyId        String?
  agentSessionId String?
  createdAt      DateTime @default(now())

  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  story   Story?   @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([storyId])
}
